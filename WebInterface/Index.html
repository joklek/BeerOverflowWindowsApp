<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="Content/bootstrap.min.css">
    <link rel="stylesheet" href="Content/Style.css">
    <link rel="stylesheet" href="Content/DataTables/media/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" href="lentele.css">
    <script src="Scripts/jquery-3.2.1.min.js"></script>
    <script src="Scripts/bootstrap.min.js"></script>
    <script src="Scripts/DataTables/media/js/jquery.dataTables.min.js"></script>
    <script src="Scripts/DataTables/media/js/dataTables.bootstrap.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?sensor=false&key=AIzaSyABC7_vGTsEEEvHlUAcBom9JYvJ5q2tooc" type="text/javascript"></script>
    <title></title>
</head>
<body>

    <div id="nav-placeholder">
    </div>

    <script>
        $(function () {
            $("#nav-placeholder").load("NavBar.html");
        });
    </script>

    <button onclick="GetData()" id="loadBars">Load bars</button>

    <input type="button" id="Rate" value="Rate" />

    <select id="ratings">
        <option value="1" selected="selected">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
    </select>

    <table class="table table-bordered table-condensed table-hover" id="barsTable">
        <thead>
            <tr>
                <th>Id</th>
                <th>Title</th>
                <th>Category</th>
                <th>Rating</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div id="map"></div>
</body>
</html>
<script>
    var email;
    var pass;
    var map = null;
    var markers = [];
    var myLocation = null;
    $(document).ready(function () {
        $('#barsTable').DataTable({
            columns: [
                { data: 'BarId' },
                { data: 'Title' },
                { data: 'Categories' },
                { data: 'AvgRating' },
                { data: 'StreetAddress' }
            ]
        });
        initMap();
    });
    function addMarker(position, label) {

        var marker = new google.maps.Marker({
            position: position,
            title: label,
            map: map
        });
        setMapOnAll(null);
        myLocation = null;
        myLocation = marker;
        setMapOnAll(map);
    }
    function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
        }
        if (myLocation != null) {
            myLocation.setMap(map);
        }
    }
    function GetData() {
        beginLoading();
        jQuery.support.cors = true;
        var coordinates = null;
        if (myLocation != null) {
            coordinates = { lat: myLocation.getPosition().lat(), lng: myLocation.getPosition().lng() }
            $.ajax({
                url: "http://localhost:1726/Api/Data/GetBarsByCoordinates",
                type: "POST",
                data: JSON.stringify(coordinates),
                contentType: "application/json",
                type: "POST",
                error: function (request, status, error) {
                    stopLoading();
                    alert(request.responseText);
                },
                success: function (data) {
                    markers = [];
                    for (var i = 0; i < data.length; i++) {
                        var marker = new google.maps.Marker({
                            position: { lat : data[i].Latitude, lng : data[i].Longitude },
                            title: data[i].Title,
                            map: map
                        });
                        markers.push(marker);                       
                    }
                    setMapOnAll(null);
                    setMapOnAll(map);
                    $('#barsTable').DataTable().clear();
                    $('#barsTable').DataTable().rows.add(data).draw();
                    stopLoading();
                }
            });
        } 
        else {
            alert("Select your location");
        } 
    }
    
    function initMap() {

        var myLatLng = { lat: 54.684815, lng: 25.288464 };
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                myLatLng = { lat: position.coords.latitude, lng: position.coords.longitude };
                LoadMap(myLatLng);
                var marker = new google.maps.Marker({
                    position: myLatLng,
                    map: map,
                    title: 'My location'
                });
                myLocation = marker;
            });
        }        
        else {
            LoadMap(myLatLng);
        }     
    }
    function LoadMap(myLatLng) {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 14,
            center: myLatLng
        });
        google.maps.event.addListener(map, 'click', function (event) {
            addMarker(event.latLng, "My location");
        });
    } 

    function beginLoading() {
        $("#loadBars").text("Loading...");
        $("#loadBars").prop('disabled', true);
    }
    function stopLoading() {
        $("#loadBars").text("Load bars");
        $("#loadBars").prop('disabled', false);
    }

    var value;

    var table = document.getElementsByTagName("table")[0];
    var tbody = table.getElementsByTagName("tbody")[0];
    tbody.onclick = function (e) {
        e = e || window.event;
        var target = e.srcElement || e.target;
        while (target && target.nodeName !== "TR") {
            target = target.parentNode;
        }
        if (target) {
            var cells = target.getElementsByTagName("td");
            value = cells[0].innerText;
        }
    };


    function SaveBarRating(rating) {
        if (value != null)
        {
            if (sessionStorage.getItem("email") != null && sessionStorage.getItem("pass") != null) {
                beginLoading();
                $('table').find('tr.highlight').removeClass('highlight');
                jQuery.support.cors = true;
                data = { BarID: value, Rating: rating, User: { Username: sessionStorage.getItem("email"), Password: sessionStorage.getItem("pass") } }
                $.ajax({
                    url: "http://localhost:1726/Api/Data/SaveBarRating",
                    type: "POST",
                    data: JSON.stringify(data),
                    contentType: "application/json",
                    type: "POST",
                    error: function (request, status, error) {
                        stopLoading();
                        alert(request.responseText);
                    },
                    success: function (data) {
                        value = null;
                        stopLoading();
                    }
                });
            } else
                alert("you have to LogIn in order to rate a bar");
        }
        else
            alert("No bar selected");

    }

    $('#Rate').on('click', function (e) {
        var e = document.getElementById("ratings");
        var rating = e.options[e.selectedIndex].value;
        SaveBarRating(rating);
    });

    $('table').on('click', 'tr', function (e) {
        $('table').find('tr.highlight').removeClass('highlight');
        $(this).addClass('highlight');
    })

 //   window.onbeforeunload = function () {
 //       sessionStorage.clear();
 //   };
</script>